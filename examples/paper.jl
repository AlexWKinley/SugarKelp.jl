using Plots, Dates, Measures, Interpolations, RollingFunctions, NumericalIntegration

include("../src/Kelp.jl")
include("../src/parameters.jl")

offset = 212 - 25
# collected from fig2 of origional paper with https://www.graphreader.com/
temp_t = [20.956,31.796,43.358,65.036,67.927,82.38,86.715,99.723,111.285,124.292,147.416,209.562,238.467,296.277,328.073,356.978,394.555,412.62]
temp = [12.255,14.387,13.177,12.947,12.082,12.313,11.333,11.103,9.663,10.181,6.609,3.383,2.461,8.107,12.658,15.251,14.617,13.811]
no3_t = [26.737,79.489,128.628,203.781,228.35,258.701,268.818,299.168,325.182,399.613]
no3 = [0.198,0.428,5.136,7.045,2.798,5.333,0.23,0.428,0.132,0.132]
irr_t = [18.5122,28.9756,38.6341,46.6829,59.561,74.0488,88.5366,107.8537,135.2195,170.6341,199.6098,226.9756,247.9024,267.2195,273.6585,288.1463,297.8049,310.6829,318.7317,328.3902,331.6098,347.7073,355.7561,363.8049,376.6829,386.3415,396.8049]
irr = [8.3951,7.4074,5.5967,4.2798,2.7984,1.6461,0.9877,0.4938,0.3292,0.9877,3.6214,6.0905,6.0905,7.2428,10.6996,18.7654,33.9095,33.7449,30.9465,25.0206,20.5761,19.4239,16.7901,13.4979,11.0288,8.7243,6.749]
# no3 ./= 1
irr .*= 10^6 / (24 * 60 * 60)#
temp_t .+= offset ;no3_t .+= offset ;irr_t .+= offset 

t_i = 31 * 4 + 28 + 2 * 30.0 + 15
nd = 365
lat = 60.25
u = 0.15

u_arr = Interpolations.LinearInterpolation([t_i:t_i + nd;], fill(u, Int(nd + 1)))

temp_arr = Interpolations.LinearInterpolation(temp_t, temp, extrapolation_bc=Line())
no3_arr = Interpolations.LinearInterpolation(no3_t, no3, extrapolation_bc=Line())
irr_arr = Interpolations.LinearInterpolation(irr_t, irr, extrapolation_bc=Line())

a_0 = 30;n_0 = 0.01;c_0 = 0.6

solution, results = Kelp.solvekelp(t_i, nd, u_arr, temp_arr, irr_arr, no3_arr, lat, a_0, n_0, c_0)

temp_disp = [];irr_disp = [];n_disp = [];

t_disp = solution.t

pyplot()
plot(layout=grid(2, 3))

plot!(temp_t,temp,sp=1,ylabel="Temperature/degC",legend=true)
plot!(irr_t,irr,sp=2,ylabel="Irradiance/micro mol photons / m^2 / s",legend=true)
plot!(no3_t,no3,sp=3,ylabel="Nitrate/micro mol / L",legend=true)

offset += 25
# sjotun 1993
c_t = [10.016,100.156,130.973,164.872,192.607,224.965,266.568,291.222,343.611,409.097] .+ offset 
c = [0.312,0.349,0.292,0.195,0.224,0.266,0.281,0.307,0.363,0.373]
n_t = [10.255,96.239,135.681,160.924,195.633,222.454,269.785,288.717,345.514,406.255] .+ offset 
n = [0.007,0.014,0.021,0.024,0.025,0.022,0.023,0.017,0.012,0.013]
a_t = [16,17,18,19,20,21,22,23,24,25,26,27,28,29,30,31,32,33,34,35,36,37,38,39,40,41,42,43,44,45,46,47,48,49,50,51,52,53,54,55,56,57,58,59,60,61,62,63,64,65,66,67,68,69,70,71,72,73,74,75,76,77,78,79,80,81,82,83,84,85,86,87,88,89,90,91,92,93,94,95,96,97,98,99,100,101,102,103,104,105,106,107,108,109,110,111,112,113,114,115,116,117,118,119,120,121,122,123,124,125,126,127,128,129,130,131,132,133,134,135,136,137,138,139,140,141,142,143,144,145,146,147,148,149,150,151,152,153,154,155,156,157,158,159,160,161,162,163,164,165,166,167,168,169,170,171,172,173,174,175,176,177,178,179,180,181,182,183,184,185,186,187,188,189,190,191,192,193,194,195,196,197,198,199,200,201,202,203,204,205,206,207,208,209,210,211,212,213,214,215,216,217,218,219,220,221,222,223,224,225,226,227,228,229,230,231,232,233,234,235,236,237,238,239,240,241,242,243,244,245,246,247,248,249,250,251,252,253,254,255,256,257,258,259,260,261,262,263,264,265,266,267,268,269,270,271,272,273,274,275,276,277,278,279,280,281,282,283,284,285,286,287,288,289,290,291,292,293,294,295,296,297,298,299,300,301,302,303,304,305,306,307,308,309,310,311,312,313,314,315,316,317,318,319,320,321,322,323,324,325,326,327,328,329,330,331,332,333,334,335,336,337,338,339,340,341,342,343,344,345,346,347,348,349,350,351,352,353,354,355,356,357,358,359,360,361,362,363,364,365,366,367,368,369,370,371,372,373,374,375,376,377,378,379,380,381,382,383,384,385,386,387,388,389,390,391,392,393,394,395,396,397,398] .+ offset 
a = [29.264,29.273,29.273,29.273,29.273,29.273,29.273,29.273,29.273,29.273,29.273,29.273,29.273,29.273,29.273,29.273,29.273,29.273,29.273,29.273,29.273,29.273,29.277,29.366,29.455,29.544,29.633,29.722,29.811,29.9,29.989,30.078,30.167,30.256,30.345,30.434,30.523,30.612,30.701,30.79,30.879,30.968,31.057,31.146,31.24,31.336,31.433,31.529,31.625,31.722,31.818,31.915,32.011,32.107,32.204,32.3,32.397,32.493,32.59,32.686,32.782,32.879,32.975,33.072,33.142,33.207,33.271,33.335,33.399,33.464,33.528,33.592,33.657,33.721,33.785,33.849,33.914,33.978,34.042,34.107,34.171,34.235,34.299,34.364,34.466,34.569,34.672,34.775,34.878,34.981,35.084,35.186,35.289,35.392,35.495,35.598,35.701,35.803,35.906,36.009,36.112,36.215,36.318,36.421,36.523,36.626,36.729,36.832,36.948,37.102,37.256,37.41,37.565,37.719,37.873,38.028,38.182,38.336,38.49,38.645,38.799,38.953,39.107,39.262,39.416,39.551,39.68,39.808,39.937,40.065,40.194,40.322,40.451,40.579,40.708,40.868,41.033,41.198,41.364,41.529,41.694,41.86,42.025,42.19,42.355,42.521,42.617,42.553,42.489,42.424,42.36,42.296,42.231,42.167,42.103,42.039,42,42,42,42,42,42,42,42,42,42,42,42,42.025,42.055,42.085,42.114,42.144,42.174,42.203,42.233,42.263,42.292,42.322,42.352,42.381,42.411,42.441,42.47,42.5,42.53,42.559,42.589,42.619,42.627,42.603,42.579,42.554,42.53,42.506,42.482,42.458,42.434,42.41,42.386,42.362,42.337,42.313,42.289,42.265,42.241,42.217,42.193,42.169,42.145,42.121,42.096,42.072,42.048,42.024,42,42.051,42.103,42.154,42.206,42.257,42.309,42.36,42.411,42.463,42.514,42.566,42.617,42.669,42.72,42.771,42.823,42.874,42.926,42.977,43.028,43.08,43.131,43.183,43.234,43.292,43.369,43.446,43.523,43.601,43.678,43.755,43.832,43.909,43.986,44.063,44.14,44.218,44.295,44.372,44.449,44.526,44.473,44.377,44.28,44.184,44.087,43.991,43.895,43.798,43.702,43.605,43.509,43.413,43.316,43.22,43.123,43.027,42.93,42.834,42.738,42.641,42.584,42.529,42.474,42.419,42.364,42.309,42.253,42.198,42.143,42.088,42.033,41.978,41.923,41.868,41.813,41.758,41.702,41.647,41.592,41.537,41.482,41.427,41.372,41.265,41.15,41.034,40.918,40.802,40.687,40.571,40.455,40.34,40.224,40.108,39.993,39.877,39.761,39.645,39.53,39.425,39.339,39.253,39.167,39.082,38.996,38.91,38.825,38.739,38.653,38.567,38.482,38.396,38.31,38.225,38.182,38.182,38.182,38.182,38.182,38.182,38.182,38.182,38.182,38.182,38.182,38.182,38.182,38.149,38.039,37.928,37.818,37.708,37.598,37.488,37.377,37.267,37.157,37.047,36.937,36.851,36.774,36.697,36.62,36.543,36.466,36.388,36.311,36.234,36.157,36.08,36.003,35.926,35.848,35.771,35.694,35.652,35.717,35.781,35.845,35.91,35.974,36.038,36.102,36.167,36.231,36.295]
c2_t = [5.4141,17.0156,32.4844,49.5,61.875,85.0781,103.6406,122.2031,140.7656,156.2344,165.5156,182.5312,193.3594,207.2812,219.6562,238.2188,266.0625,289.2656,312.4688,329.4844,349.5938,369.7031,388.2656,398.3203] .+ offset 
c2 = [0.35,0.3536,0.3554,0.3536,0.3491,0.3347,0.3123,0.2781,0.244,0.2162,0.2018,0.2072,0.2243,0.2458,0.2701,0.297,0.3168,0.3401,0.3572,0.3653,0.3689,0.3689,0.368,0.3671]
n2_t = [14.8696,32.8696,57.913,75.1304,90.7826,104.8696,125.2174,145.5652,156.5217,162.7826,170.6087,178.4348,184.6957,194.087,200.3478,214.4348,237.913,248.8696,259.8261,267.6522,270.7826,273.913,278.6087,288,297.3913,308.3478,316.1739,327.1304,336.5217,352.1739,364.6957,378.7826,396.7826] .+ offset 
n2 = [0.0088,0.0095,0.0109,0.0124,0.0146,0.017,0.0209,0.0249,0.027,0.0284,0.0291,0.0285,0.0281,0.0265,0.025,0.0229,0.0189,0.0175,0.0165,0.0154,0.0145,0.0136,0.0127,0.0112,0.0102,0.0095,0.0091,0.0086,0.0083,0.0083,0.0084,0.0086,0.0088]
# structural to dry weight conversion (paper plots g/g dry weight where as g/g structural weight is used in calculations), I think they are also plotting the total carbon not just the reserve
n_factor = (results.nitrogen .- N_min) .* K_N
c_factor = (results.carbon .- C_min) .* K_C
w_factor = 1 .+ n_factor .+ c_factor .+ C_min .+ N_min

plot!(t_disp,results.area,sp=4,xlabel="Month", ylabel="Frond Area/dm^2",ylim=(30, 45),label="Model, update")
plot!(a_t,a,label="Paper",sp=4)

plot!(t_disp,(results.nitrogen .+ N_struct) ./ w_factor,sp=5, xlabel="Month", ylabel="Nitrogen reserve/gN/g dw",label="Model, update")
plot!(n_t,n,sp=5,seriestype=:scatter, label="Sjotun, 1993")
plot!(n2_t,n2,label="Paper",sp=5)

plot!(t_disp,(results.carbon .+ C_struct) ./ w_factor,sp=6, xlabel="Month", ylabel="Carbon reserve/gC/g dw",label="Model, update")
plot!(c_t,c,sp=6,seriestype=:scatter, label="Sjotun, 1993",legend=:bottomleft)
plot!(c2_t,c2,label="Paper",sp=6)

t_ticks = []
val_ticks = []
for day in t_i:t_i + nd
    date = Date(1981, 1, 1) + Dates.Day(day)
    if Dates.format(date, "d") == "1"
        push!(t_ticks, day)
        push!(val_ticks, Dates.format(date, "U")[1])
    end
end

plot!(xticks=(t_ticks, val_ticks),margin=-3mm)
plot!(top_margin=0mm)
display(display(plot!()))

c_fixed = integrate(solution.t[2:end], diff(results.carbon) .* (K_A .* results.area[2:end]))

mu = []

delts = []
for j = 1:365
    theta = 0.2163108 + 2 * atan(0.9671396 * tan(0.00860 * (j - 186))) # revolution angle from day of the year
    dec = asin(0.39795 * cos(theta)) # sun declination angle 
    p = 0.8333 # sunrise/sunset is when the top of the sun is apparently even with horizon
    push!(
            delts,
            24 -
            (24 / pi) * acos(
                (sin(p * pi / 180) + sin(lat * pi / 180) * sin(dec)) /
                (cos(lat * pi / 180) * cos(dec)),
            ),
        )
end
DeltaL = diff(delts)
push!(DeltaL, DeltaL[364])
NormDeltaL = DeltaL / findmax(DeltaL)[1]

    
for (ind, t) in enumerate(solution.t)
    d = trunc(Int, mod(floor(t), 365) + 1)
    lambda =  NormDeltaL[d] # This seems wrong to be interpolated because "change in day length" is discrete so going to stick choosing day numbers
    # On the other hand the other parameters could be time series with higher resolution than once per day (but again is that valid with this model because they just one per day)

    f_area = m_1 * exp(-(results.area[ind] / A_0)^2) + m_2 # effect of size on growth rate
    
    temp = temp_arr(t)
    
    if temp < 10 # effect of temperature on growth rate
        f_temp = 0.08 * temp + 0.2
    elseif temp < 15
        f_temp = 1
    elseif temp < 19
        f_temp = 19 / 4 - temp / 4
    else
        f_temp = 0
    end
    
    f_photo = a_1 * (1 + sign(lambda) * sqrt(abs(lambda))) + a_2
        
    push!(mu, f_area * f_temp * f_photo * min(1 - N_min / results.nitrogen[ind], 1 - C_min / results.carbon[ind]))
end

gross_a = integrate(solution.t, mu .* results.area)

println("Total carbon fixed: $c_fixed /g")
println("Gross frond area: $gross_a /dm^2")